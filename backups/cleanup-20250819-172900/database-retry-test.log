🚀 开始数据库连接重试机制测试
测试时间: Tue Aug 19 09:03:22 CST 2025
项目目录: /home/devbox/project
=

开始数据库连接重试机制测试...
📋 检查依赖...
✅ Node.js 版本: v20.19.4
✅ npm 版本: 10.8.2
✅ 依赖检查完成

🔧 检查环境变量...
✅ MONGODB_URL: mongodb://root:td6sz...
✅ 环境变量检查完成

🔨 编译 TypeScript 代码...
❌ TypeScript 编译检查失败
🚀 开始数据库连接重试机制测试
测试时间: Tue Aug 19 09:11:07 CST 2025
项目目录: /home/devbox/project
=

开始数据库连接重试机制测试...
📋 检查依赖...
✅ Node.js 版本: v20.19.4
✅ npm 版本: 10.8.2
✅ 依赖检查完成

🔧 检查环境变量...
✅ MONGODB_URL: mongodb://root:td6sz...
✅ 环境变量检查完成

🔨 编译 TypeScript 代码...
✅ TypeScript 编译检查通过

🔄 测试数据库连接重试机制...
启动数据库重试测试...
🚀 开始数据库连接重试机制测试
测试配置: {
  testDuration: 60000,
  statusCheckInterval: 5000,
  simulateDisconnection: true,
  disconnectionDelay: 20000
}
============================================================
📡 尝试连接数据库...
✅ 数据库连接成功
[5s] 状态检查:
  连接状态: connected
  健康状态: 健康
  重连次数: 0
  正在连接: 否
----------------------------------------
[10s] 状态检查:
  连接状态: connected
  健康状态: 健康
  重连次数: 0
  正在连接: 否
----------------------------------------
[15s] 状态检查:
  连接状态: connected
  健康状态: 健康
  重连次数: 0
  正在连接: 否
----------------------------------------
🔌 模拟数据库连接中断...
[20s] 状态检查:
  连接状态: disconnecting
  健康状态: 不健康
  重连次数: 0
  正在连接: 否
----------------------------------------
⚠️  数据库连接已断开，等待自动重连...
[25s] 状态检查:
  连接状态: connected
  健康状态: 健康
  重连次数: 0
  正在连接: 否
----------------------------------------
[30s] 状态检查:
  连接状态: connected
  健康状态: 健康
  重连次数: 0
  正在连接: 否
----------------------------------------
[35s] 状态检查:
  连接状态: connected
  健康状态: 健康
  重连次数: 0
  正在连接: 否
----------------------------------------
[40s] 状态检查:
  连接状态: connected
  健康状态: 健康
  重连次数: 0
  正在连接: 否
----------------------------------------
[45s] 状态检查:
  连接状态: connected
  健康状态: 健康
  重连次数: 0
  正在连接: 否
----------------------------------------
[50s] 状态检查:
  连接状态: connected
  健康状态: 健康
  重连次数: 0
  正在连接: 否
----------------------------------------
[55s] 状态检查:
  连接状态: connected
  健康状态: 健康
  重连次数: 0
  正在连接: 否
----------------------------------------
🏁 测试完成

📊 测试报告
============================================================
总检查次数: 11
健康检查次数: 10
不健康检查次数: 1
健康率: 90.91%

连接状态分布:
  connected: 10 次 (90.91%)
  disconnecting: 1 次 (9.09%)

最大重连尝试次数: 0

测试详细数据已保存到内存中，可通过日志查看完整记录。
✅ 数据库重试测试完成

🧪 运行数据库连接单元测试...

> language-learning-backend@1.0.0 test
> jest --testPathPattern=database-connection-retry.test.ts --verbose

PASS src/tests/database-connection-retry.test.ts
  数据库连接重试机制测试
    连接状态管理
      ✓ 应该能够获取连接状态信息 (3 ms)
      ✓ 应该能够检查数据库健康状态 (1 ms)
    连接重试逻辑
      ✓ 应该在连接失败时返回适当的错误信息 (56 ms)
    连接池配置
      ✓ 应该使用正确的连接池配置 (1 ms)
    错误处理
      ✓ 应该能够处理数据库连接错误 (1 ms)
      ✓ 应该提供详细的错误信息 (1 ms)
    连接状态监控
      ✓ 应该正确报告连接状态 (1 ms)
      ✓ 应该跟踪重连尝试次数

Test Suites: 1 passed, 1 total
Tests:       8 passed, 8 total
Snapshots:   0 total
Time:        3.27 s, estimated 5 s
Ran all test suites matching /database-connection-retry.test.ts/i.
✅ 单元测试通过

🏥 测试健康检查端点...
启动后端服务...
等待服务启动...
测试健康检查端点: http://localhost:3000/api/health
✅ 健康检查端点响应正常
健康状态响应: {"status":"healthy","timestamp":"2025-08-19T01:12:30.483Z","uptime":9.925108664,"environment":"production","version":"1.0.0","memory":{"used":43,"total":54,"external":21},"services":{"database":"connected","openai":"configured","elevenlabs":"not_configured","pexels":"configured"},"database_details":{"healthy":true,"state":"connected","reconnectAttempts":0,"isConnecting":false,"status":"connected","readyState":1,"host":"wordpecker-db-mongodb.ns-t1zw83xe.svc","port":27017,"name":"wordpecker"}}
测试就绪检查端点: http://localhost:3000/api/ready
✅ 就绪检查端点响应正常
就绪状态响应: {"ready":true,"timestamp":"2025-08-19T01:12:33.135Z","checks":{"database":true,"requiredAPIs":true,"optionalAPIs":true,"connectivity":true},"details":{"database":{"status":"connected","state":"connected","reconnectAttempts":0,"readyState":1,"host":"wordpecker-db-mongodb.ns-t1zw83xe.svc","port":27017,"name":"wordpecker"},"apis":{"openai":{"configured":true,"accessible":true},"elevenlabs":{"configured":false,"accessible":false},"pexels":{"configured":true,"accessible":true}}},"warnings":["ElevenLabs API key not configured (optional)"]}
停止后端服务...

📊 生成测试报告...
✅ 测试报告已生成: /home/devbox/project/logs/database-retry-test-report.md

🎉 数据库连接重试机制测试完成！
查看完整日志: /home/devbox/project/logs/database-retry-test.log
